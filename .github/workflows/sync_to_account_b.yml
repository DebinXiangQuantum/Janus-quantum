name: Sync to Backup Account

on:
  push:
    branches:
      - main  # 或者你的主分支名称

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须获取完整历史，防止 force push 冲突
      - name: Diagnostic Test
        run: |
          echo "Testing Classic URL..."
          git ls-remote https://${{ secrets.BACKUP_TOKEN }}@github.com/xiangdebinBackup/Janus-quantum.git HEAD
          
          echo "Testing with Username..."
          # 把下面的 'xiangdebinBackup' 替换为你账号B的真实用户名
          git ls-remote https://xiangdebinBackup:${{ secrets.BACKUP_TOKEN }}@github.com/xiangdebinBackup/Janus-quantum.git HEAD
      - name: Push to Account B
        run: |
          # 1. 配置 Git 用户信息（防止 Git 识别为匿名用户）
          # 1. 核心步骤：移除 Actions 自动注入的认证头（这是解决 403 的关键）
          git config --local --unset-all http.https://github.com/.extraheader || true

          # 2. 配置虚拟用户信息
          git config --global user.email "xiangdebin3@gmail.com"
          git config --global user.name "xiangdebinBackup"

          # 3. 重新设置远程仓库（确保地址绝对正确）
          # 注意：URL 里面直接嵌入 Token
          REMOTE_URL="https://${{ secrets.BACKUP_TOKEN }}@github.com/xiangdebinBackup/Janus-quantum.git"
          
          # 先移除可能存在的 backup 远程，再添加
          git remote remove backup || true
          git remote add backup "$REMOTE_URL"

          # 4. 执行推送
          # 我们不使用简单的 push，而是指定引用，确保它是推送到 B 的 main
          git push backup HEAD:main --force
